<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" 
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="com.xier.sesame.attence.RecognizeDailyReport">
			
	<resultMap id="RecognizeDailyReportResultMap" type="com.xier.sesame.attence.domain.RecognizeDailyReport">
	<result column="recognize_daily_report_id" property="recognizeDailyReportId" />
	<result column="org_id" property="orgId" />
	<result column="report_date" property="reportDate" />
	<result column="total_times" property="totalTimes" />
	<result column="employee_times" property="employeeTimes" />
	<result column="visitor_times" property="visitorTimes" />
	<result column="stanger_times" property="stangerTimes" />
	<result column="gmt_create" property="gmtCreate" />
	<result column="gmt_modify" property="gmtModify" />
	</resultMap>
	
	<insert id="addRecognizeDailyReport" parameterType="com.xier.sesame.attence.domain.RecognizeDailyReport">

		insert into attence_recognize_daily_report(
			recognize_daily_report_id,
			org_id,
			report_date,
			total_times,
			employee_times,
			visitor_times,
			stanger_times,
			gmt_create,
			gmt_modify	
		)
		values (
		 	#{recognizeDailyReportId},
			#{orgId},
			#{reportDate},
			#{totalTimes},
			#{employeeTimes},
			#{visitorTimes},
			#{stangerTimes},
			now(3),
			now(3)
		)
	</insert>
	
	<update id="updateRecognizeDailyReport" parameterType="com.xier.sesame.attence.domain.RecognizeDailyReport">
		update attence_recognize_daily_report
		set
			report_date=#{reportDate},
			total_times=#{totalTimes},
			employee_times=#{employeeTimes},
			visitor_times=#{visitorTimes},
			stanger_times=#{stangerTimes},
			gmt_modify = now(3)
		where
			recognize_daily_report_id = #{recognizeDailyReportId}
			and org_id=#{orgId}
	</update>
	
	<update id="updateRecognizeDailyReportSelective" parameterType="com.xier.sesame.attence.domain.RecognizeDailyReport">
		update attence_recognize_daily_report
		<set>
		<if test="reportDate != null">
			report_date=#{reportDate},
		</if>
		<if test="totalTimes != null">
			total_times=#{totalTimes},
		</if>
		<if test="employeeTimes != null">
			employee_times=#{employeeTimes},
		</if>
		<if test="visitorTimes != null">
			visitor_times=#{visitorTimes},
		</if>
		<if test="stangerTimes != null">
			stanger_times=#{stangerTimes},
		</if>
			gmt_modify = now(3)
		</set>
		where
			recognize_daily_report_id = #{recognizeDailyReportId}
			and org_id=#{orgId}
	</update>
   
 	<select id="getRecognizeDailyReportById" parameterType="com.xier.sesame.attence.domain.RecognizeDailyReport" resultMap="RecognizeDailyReportResultMap">
<include refid="sql_select"/>
		from attence_recognize_daily_report
		where 
			recognize_daily_report_id = #{recognizeDailyReportId}
			and org_id=#{orgId}
	</select>

	<select id="getRecordCountByTimeRangeAndOrgId" parameterType="map" resultMap="RecognizeDailyReportResultMap">
		select recognize_daily_report_id,
		org_id,
		SUM(total_times) as total_times,
		SUM(employee_times) as employee_times,
		SUM(visitor_times)as visitor_times,
		SUM(stanger_times) as stanger_times,
		now(3) as gmt_create,
		now(3) as gmt_modify
		from attence_recognize_daily_report
		where
		<![CDATA[ report_date >= #{startTime}]]>
		<![CDATA[ and report_date < #{endTime}]]>
		and org_id=#{orgId}
	</select>

	<select id="getSourceRecordCountByTimeRangeAndOrgId" parameterType="map" resultMap="RecognizeDailyReportResultMap">
		select
		UUID() as recognize_daily_report_id,
		t.org_id,
		now(3) as report_date,
		SUM(total_count) AS total_times,
		SUM(IF(recognize_user_type=1,total_count,0)) AS "employee_times",
		SUM(IF(recognize_user_type=2,total_count,0)) AS "visitor_times",
		SUM(IF(recognize_user_type=3,total_count,0)) AS "stanger_times",
		NOW(3) as "gmt_create",
		NOW(3) as "gmt_modify"
		from
		(select org_id,recognize_user_type,COUNT(1) as total_count
		from attence_recognize_record
		where
		org_id=#{orgId}
		<![CDATA[ and recognize_time >= #{startTime}]]>
		<![CDATA[ and recognize_time < #{endTime}]]>
		GROUP BY org_id,recognize_user_type ) as t
		where
		org_id=#{orgId}
	</select>
	
 	<select id="getRecognizeDailyReportByIdForUpdate" parameterType="com.xier.sesame.attence.domain.RecognizeDailyReport" resultMap="RecognizeDailyReportResultMap">
<include refid="sql_select"/>
		from attence_recognize_daily_report
		where 
			recognize_daily_report_id = #{recognizeDailyReportId}
			and org_id=#{orgId}
	for update
	</select>
		
	<delete id="removeRecognizeDailyReportById" parameterType="com.xier.sesame.attence.domain.RecognizeDailyReport">
		delete from attence_recognize_daily_report
		where
		recognize_daily_report_id = #{recognizeDailyReportId}
		and org_id=#{orgId}
 	</delete>
 	
	<select id="getPaginationRecognizeDailyReport" resultMap="RecognizeDailyReportResultMap" parameterType="map" >
<include refid="sql_select"/>			
<include refid="sql_where"/>
			order by gmt_modify desc
			 	limit #{startRow}, #{pageSize}
	</select>
  
	<select id="getRecognizeDailyReportCount" resultType="int" parameterType="com.xier.sesame.attence.domain.RecognizeDailyReport" >
		select 
			count(*)		
<include refid="sql_where"/>
	</select>






	
	<sql id="sql_where">
	    from attence_recognize_daily_report
	    <where>
    	<if test="recognizeDailyReportId != null">
		      recognize_daily_report_id = #{recognizeDailyReportId}
		</if>
		<if test="orgId != null">
		      and org_id = #{orgId}
		</if>
		<if test="reportDate != null">
		      and report_date = #{reportDate}
		</if>
		<if test="totalTimes != null">
		      and total_times = #{totalTimes}
		</if>
		<if test="employeeTimes != null">
		      and employee_times = #{employeeTimes}
		</if>
		<if test="visitorTimes != null">
		      and visitor_times = #{visitorTimes}
		</if>
		<if test="stangerTimes != null">
		      and stanger_times = #{stangerTimes}
		</if>
		</where>
	</sql>  	
	
	<sql id="sql_select">
		select
			recognize_daily_report_id,
			org_id,
			report_date,
			total_times,
			employee_times,
			visitor_times,
			stanger_times,
			gmt_create,
			gmt_modify	
	</sql>  
</mapper>