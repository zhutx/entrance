<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" 
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="com.xier.sesame.attence.RecognizeRecord">
			
	<resultMap id="RecognizeRecordResultMap" type="com.xier.sesame.attence.domain.RecognizeRecord">
	<result column="recognize_record_id" property="recognizeRecordId" />
	<result column="person_id" property="personId" />
	<result column="user_id" property="userId" />
	<result column="face_pic_id" property="facePicId" />
	<result column="org_id" property="orgId" />
	<result column="catch_image_url" property="catchImageUrl" />
	<result column="match_image_url" property="matchImageUrl" />
	<result column="mobile" property="mobile" />
	<result column="identity_no" property="identityNo" />
	<result column="unique_number" property="uniqueNumber" />
	<result column="device_name" property="deviceName" />
	<result column="org_name" property="orgName" />
	<result column="recognize_time" property="recognizeTime" />
	<result column="sub_org_id" property="subOrgId" />
	<result column="sub_org_code" property="subOrgCode" />
	<result column="sub_org_remark" property="subOrgRemark" />
	<result column="relation_sub_org_remark" property="relationSubOrgRemark" />
	<result column="department" property="department" />
	<result column="department_id" property="departmentId" />
	<result column="quality" property="quality" />
	<result column="confidence" property="confidence" />
	<result column="recognize_type" property="recognizeType" />
	<result column="real_name" property="realName" />
	<result column="recognize_user_type" property="recognizeUserType" />
	<result column="status" property="status" />
	<result column="sync_status" property="syncStatus" />
	<result column="retry_count" property="retryCount" />
	<result column="next_retry_time" property="nextRetryTime" />
	<result column="gmt_create" property="gmtCreate" />
	<result column="gmt_modify" property="gmtModify" />
	</resultMap>
	
	<resultMap id="RecognizeRecordViewResultMap" type="com.xier.sesame.attence.domain.RecognizeRecordView">
	<result column="recognize_record_id" property="recognizeRecordId" />
	<result column="person_id" property="personId" />
	<result column="user_id" property="userId" />
	<result column="face_pic_id" property="facePicId" />
	<result column="org_id" property="orgId" />
	<result column="catch_image_url" property="catchImageUrl" />
	<result column="match_image_url" property="matchImageUrl" />
	<result column="mobile" property="mobile" />
	<result column="identity_no" property="identityNo" />
	<result column="unique_number" property="uniqueNumber" />
	<result column="device_name" property="deviceName" />
	<result column="org_name" property="orgName" />
	<result column="recognize_time" property="recognizeTime" />
	<result column="sub_org_id" property="subOrgId" />
	<result column="sub_org_code" property="subOrgCode" />
	<result column="sub_org_remark" property="subOrgRemark" />
	<result column="relation_sub_org_remark" property="relationSubOrgRemark" />
	<result column="department" property="department" />
	<result column="department_id" property="departmentId" />
	<result column="quality" property="quality" />
	<result column="confidence" property="confidence" />
	<result column="recognize_type" property="recognizeType" />
	<result column="real_name" property="realName" />
	<result column="recognize_user_type" property="recognizeUserType" />
	<result column="status" property="status" />
	<result column="gmt_create" property="gmtCreate" />
	<result column="gmt_modify" property="gmtModify" />
	</resultMap>
	
	<resultMap id="RecognizeRecordTodayResultMap" type="com.xier.sesame.attence.domain.RecognizeRecordToday">
	<result column="recognize_user_type" property="recognizeUserType" />
	<result column="recognize_count" property="recognizeCount" />
	</resultMap>
	
	<resultMap id="DeviceRecognizeCountTodayResultMap" type="com.xier.sesame.attence.domain.DeviceRecognizeCountToday">
	<result column="unique_number" property="uniqueNumber" />
	<result column="recognize_count" property="recognizeCount" />
	</resultMap>
	
	<resultMap id="SyncRecordResultMap" type="com.xier.sesame.attence.dto.SyncRecordResultDto">
		<result column="recognize_record_id" property="recognizeRecordId" />
		<result column="user_id" property="userId" />
		<result column="org_id" property="orgId" />
		<result column="unique_number" property="uniqueNumber" />
		<result column="recognize_time" property="recognizeTime" />
		<result column="catch_image_url" property="catchImageUrl" />
		<result column="retry_count" property="retryCount" />
	</resultMap>
	
	<insert id="addRecognizeRecord" parameterType="com.xier.sesame.attence.domain.RecognizeRecord">

		insert into attence_recognize_record(
			recognize_record_id,
			person_id,
			user_id,
			face_pic_id,
			org_id,
			catch_image_url,
			match_image_url,
			mobile,
			identity_no,
			unique_number,
			device_name,
			org_name,
			recognize_time,
			sub_org_id,
			sub_org_code,
			sub_org_remark,
			relation_sub_org_remark,
			department,
			department_id,
			quality,
			confidence,
			recognize_type,
			real_name,
			recognize_user_type,
			status,
			sync_status,
			retry_count,
			next_retry_time,
			gmt_create,
			gmt_modify	
		)
		values (
		 	#{recognizeRecordId},
			#{personId},
			#{userId},
			#{facePicId},
			#{orgId},
			#{catchImageUrl},
			#{matchImageUrl},
			#{mobile},
			#{identityNo},
			#{uniqueNumber},
			#{deviceName},
			#{orgName},
			#{recognizeTime},
			#{subOrgId},
			#{subOrgCode},
			#{subOrgRemark},
			#{relationSubOrgRemark},
			#{department},
			#{departmentId},
			#{quality},
			#{confidence},
			#{recognizeType},
			#{realName},
			#{recognizeUserType},
			#{status},
			1,
			#{retryCount},
			now(),
			now(3),
			now(3)
		)
	</insert>
	
	<update id="updateRecognizeRecord" parameterType="com.xier.sesame.attence.domain.RecognizeRecord">
		update attence_recognize_record
		set
			person_id=#{personId},
			user_id=#{userId},
			face_pic_id=#{facePicId},
			catch_image_url=#{catchImageUrl},
			match_image_url=#{matchImageUrl},
			mobile=#{mobile},
			identity_no=#{identityNo},
			unique_number=#{uniqueNumber},
			device_name=#{deviceName},
			org_name=#{orgName},
			recognize_time=#{recognizeTime},
			sub_org_id=#{subOrgId},
			sub_org_code=#{subOrgCode},
			sub_org_remark=#{subOrgRemark},
			relation_sub_org_remark=#{relationSubOrgRemark},
			department=#{department},
			department_id=#{departmentId},
			quality=#{quality},
			confidence=#{confidence},
			recognize_type=#{recognizeType},
			real_name=#{realName},
			recognize_user_type=#{recognizeUserType},
			status=#{status},
			gmt_modify = now(3)
		where
			recognize_record_id = #{recognizeRecordId}
			and org_id=#{orgId}
	</update>
	
	<update id="updateRecognizeRecordSelective" parameterType="com.xier.sesame.attence.domain.RecognizeRecord">
		update attence_recognize_record
		<set>
		<if test="personId != null">
			person_id=#{personId},
		</if>
		<if test="userId != null">
			user_id=#{userId},
		</if>
		<if test="facePicId != null">
			face_pic_id=#{facePicId},
		</if>
		<if test="catchImageUrl != null">
			catch_image_url=#{catchImageUrl},
		</if>
		<if test="matchImageUrl != null">
			match_image_url=#{matchImageUrl},
		</if>
		<if test="mobile != null">
			mobile=#{mobile},
		</if>
		<if test="identityNo != null">
			identity_no=#{identityNo},
		</if>
		<if test="uniqueNumber != null">
			unique_number=#{uniqueNumber},
		</if>
		<if test="deviceName != null">
			device_name=#{deviceName},
		</if>
		<if test="orgName != null">
			org_name=#{orgName},
		</if>
		<if test="recognizeTime != null">
			recognize_time=#{recognizeTime},
		</if>
		<if test="subOrgId != null">
			sub_org_id=#{subOrgId},
		</if>
		<if test="subOrgCode != null">
			sub_org_code=#{subOrgCode},
		</if>
		<if test="subOrgRemark != null">
			sub_org_remark=#{subOrgRemark},
		</if>
		<if test="relationSubOrgRemark != null">
			relation_sub_org_remark=#{relationSubOrgRemark},
		</if>
		<if test="department != null">
			department=#{department},
		</if>
		<if test="department != null">
			department_id=#{departmentId},
		</if>
		<if test="quality != null">
			quality=#{quality},
		</if>
		<if test="confidence != null">
			confidence=#{confidence},
		</if>
		<if test="recognizeType != null">
			recognize_type=#{recognizeType},
		</if>
		<if test="realName != null">
			real_name=#{realName},
		</if>
		<if test="recognizeUserType != null">
			recognize_user_type=#{recognizeUserType},
		</if>
		<if test="status != null">
			status=#{status},
		</if>
		<if test="syncStatus != null">
			sync_status=#{syncStatus},
		</if>
		<if test="retryCount != null">
			retry_count=#{retryCount},
		</if>
		<if test="nextRetryTime != null">
			next_retry_time=#{nextRetryTime},
		</if>
			gmt_modify = now(3)
		</set>
		where
			recognize_record_id = #{recognizeRecordId}
			and org_id=#{orgId}
	</update>
   
 	<select id="getRecognizeRecordById" parameterType="com.xier.sesame.attence.domain.RecognizeRecord" resultMap="RecognizeRecordResultMap">
<include refid="sql_select"/>
		from attence_recognize_record
		where 
			recognize_record_id = #{recognizeRecordId}
			and org_id=#{orgId}
	</select>
	
 	<select id="getRecognizeRecordByIdForUpdate" parameterType="com.xier.sesame.attence.domain.RecognizeRecord" resultMap="RecognizeRecordResultMap">
<include refid="sql_select"/>
		from attence_recognize_record
		where 
			recognize_record_id = #{recognizeRecordId}
			and org_id=#{orgId}
	for update
	</select>
		
	<delete id="removeRecognizeRecordById" parameterType="com.xier.sesame.attence.domain.RecognizeRecord">
		delete from attence_recognize_record
		where
		recognize_record_id = #{recognizeRecordId}
		and org_id=#{orgId}
 	</delete>
 	
	<select id="getPaginationRecognizeRecord" resultMap="RecognizeRecordResultMap" parameterType="map" >
	<include refid="sql_select"/>			
	<include refid="sql_where"/>
			order by gmt_modify desc
			 	limit #{startRow}, #{pageSize}
	</select>
  
	<select id="getRecognizeRecordCount" resultType="int" parameterType="com.xier.sesame.attence.domain.RecognizeRecord" >
		select 
			count(*)		
	<include refid="sql_search_view_where"/>
	</select>
	
	<select id="getPaginationRecognizeRecordView" resultMap="RecognizeRecordViewResultMap" parameterType="map" >
		<include refid="sql_select"/>			
		<include refid="sql_search_view_where"/>
			order by gmt_modify desc
			 	limit #{startRow}, #{pageSize}
	</select>

	<select id="getH5CompanyPaginationRecognizeRecordView" resultMap="RecognizeRecordViewResultMap" parameterType="map" >
		<include refid="sql_select"/>
		<include refid="sql_h5_company_search_view_where"/>
		order by gmt_modify desc
		limit #{startRow}, #{pageSize}
	</select>
  
	<select id="getRecognizeRecordViewCount" resultType="int" parameterType="com.xier.sesame.attence.domain.RecognizeRecordView" >
		select 
			count(*)		
		<include refid="sql_search_view_where"/>
	</select>

	<select id="getH5CompanyRecognizeRecordViewCount" resultType="int" parameterType="com.xier.sesame.attence.domain.RecognizeRecordView" >
		select
		count(*)
		<include refid="sql_h5_company_search_view_where"/>
	</select>
	
	<select id="getRecognizeRecordToday" resultMap="RecognizeRecordTodayResultMap" parameterType="map" >
		select recognize_user_type, count(*) as recognize_count from attence_recognize_record
		where org_id = #{orgId} 
		and FROM_UNIXTIME(left(recognize_time,10)) > CURRENT_DATE()
		group by recognize_user_type
	</select>
	
	<select id="getDeviceRecognizeCountToday" resultMap="DeviceRecognizeCountTodayResultMap" parameterType="map" >
		select unique_number, count(*) as recognize_count from attence_recognize_record
		where org_id = #{orgId} 
		<if test="recognizeUserType != null">
		    and recognize_user_type = #{recognizeUserType}
		</if>
		and FROM_UNIXTIME(left(recognize_time,10)) > CURRENT_DATE()
		group by unique_number
	</select>

	<select id="getSyncRecognizeRecord" resultMap="SyncRecordResultMap" parameterType="com.xier.sesame.attence.dto.SyncRecordDto" >
		SELECT  recognize_record_id, org_id, user_id, unique_number, recognize_time, catch_image_url, retry_count
		  FROM 	attence_recognize_record
		 WHERE  org_id=#{orgId} and sync_status=#{syncStatus} and recognize_user_type =1 and <![CDATA[next_retry_time >= #{startTime} and next_retry_time <= #{nextRetryTime}]]>
		 ORDER BY recognize_record_id
		 LIMIT  0,500
	</select>


	
	<sql id="sql_where">
	    from attence_recognize_record
	    <where>
    	<if test="recognizeRecordId != null">
		      recognize_record_id = #{recognizeRecordId}
		</if>
		<if test="personId != null">
		      and person_id = #{personId}
		</if>
		<if test="userId != null">
		      and user_id = #{userId}
		</if>
		<if test="facePicId != null">
		      and face_pic_id = #{facePicId}
		</if>
		<if test="orgId != null">
		      and org_id = #{orgId}
		</if>
		<if test="catchImageUrl != null">
		      and catch_image_url = #{catchImageUrl}
		</if>
		<if test="matchImageUrl != null">
		      and match_image_url = #{matchImageUrl}
		</if>
		<if test="mobile != null">
		      and mobile = #{mobile}
		</if>
		<if test="identityNo != null">
		      and identity_no = #{identityNo}
		</if>
		<if test="uniqueNumber != null">
		      and unique_number = #{uniqueNumber}
		</if>
		<if test="deviceName != null">
			and device_name = #{deviceName}
		</if>
		<if test="orgName != null">
		      and org_name = #{orgName}
		</if>
		<if test="recognizeTime != null">
		      and recognize_time = #{recognizeTime}
		</if>
		<if test="subOrgId != null">
		      and sub_org_id = #{subOrgId}
		</if>
		<if test="subOrgCode != null">
		      and sub_org_code = #{subOrgCode}
		</if>
		<if test="subOrgRemark != null">
		      and sub_org_remark = #{subOrgRemark}
		</if>
		<if test="relationSubOrgRemark != null">
		      and relation_sub_org_remark = #{relationSubOrgRemark}
		</if>
		<if test="department != null">
		      and department = #{department}
		</if>
		<if test="departmentId != null">
			and department_id = #{departmentId}
		</if>
		<if test="quality != null">
		      and quality = #{quality}
		</if>
		<if test="confidence != null">
		      and confidence = #{confidence}
		</if>
		<if test="recognizeType != null">
		      and recognize_type = #{recognizeType}
		</if>
		<if test="realName != null">
		      and real_name = #{realName}
		</if>
		<if test="recognizeUserType != null">
		      and recognize_user_type = #{recognizeUserType}
		</if>
		<if test="status != null">
		      and status = #{status}
		</if>
		</where>
	</sql>


	<sql id="sql_h5_company_search_view_where">
		from attence_recognize_record
		<where>
			<if test="recognizeRecordId != null">
				recognize_record_id = #{recognizeRecordId}
			</if>
			<if test="personId != null">
				and person_id = #{personId}
			</if>
			<if test="userId != null">
				and user_id = #{userId}
			</if>
			<if test="facePicId != null">
				and face_pic_id = #{facePicId}
			</if>
			<if test="orgId != null">
				and org_id = #{orgId}
			</if>
			<if test="catchImageUrl != null">
				and catch_image_url = #{catchImageUrl}
			</if>
			<if test="matchImageUrl != null">
				and match_image_url = #{matchImageUrl}
			</if>
			<if test="mobile != null">
				and mobile = #{mobile}
			</if>
			<if test="identityNo != null">
				and identity_no = #{identityNo}
			</if>
			<if test="uniqueNumber != null">
				and unique_number = #{uniqueNumber}
			</if>
			<if test="deviceName != null">
				and device_name = #{deviceName}
			</if>
			<if test="orgName != null">
				and org_name = #{orgName}
			</if>
			<if test="recognizeTime != null">
				and recognize_time = #{recognizeTime}
			</if>
			<if test="subOrgId != null">
				and sub_org_id = #{subOrgId}
			</if>
			<if test="subOrgCode != null">
				and sub_org_code = #{subOrgCode}
			</if>
			<if test="subOrgRemark != null">
				and sub_org_remark = #{subOrgRemark}
			</if>
			<if test="relationSubOrgRemark != null">
				and relation_sub_org_remark = #{relationSubOrgRemark}
			</if>
			<if test="quality != null">
				and quality = #{quality}
			</if>
			<if test="confidence != null">
				and confidence = #{confidence}
			</if>
			<if test="recognizeType != null">
				and recognize_type = #{recognizeType}
			</if>
			<if test="realName != null">
				and real_name LIKE concat('%', #{realName}, '%')
			</if>
			<if test="departmentId != null">
				and  department_id LIKE concat('%', #{departmentId}, '%')
			</if>
			<if test="recognizeUserType != null">
				and recognize_user_type = #{recognizeUserType}
			</if>
			<if test="status != null">
				and status = #{status}
			</if>
			<if test="searchBeginDate != null">
				<![CDATA[ and recognize_time >= #{searchBeginDate}]]>
			</if>
			<if test="searchEndDate != null">
				<![CDATA[ and recognize_time <= #{searchEndDate}]]>
			</if>
		</where>
	</sql>

	<sql id="sql_search_view_where">
		from attence_recognize_record
		<where>
			<if test="recognizeRecordId != null">
				recognize_record_id = #{recognizeRecordId}
			</if>
			<if test="personId != null">
				and person_id = #{personId}
			</if>
			<if test="userId != null">
				and user_id = #{userId}
			</if>
			<if test="facePicId != null">
				and face_pic_id = #{facePicId}
			</if>
			<if test="orgId != null">
				and org_id = #{orgId}
			</if>
			<if test="catchImageUrl != null">
				and catch_image_url = #{catchImageUrl}
			</if>
			<if test="matchImageUrl != null">
				and match_image_url = #{matchImageUrl}
			</if>
			<if test="mobile != null">
				and mobile = #{mobile}
			</if>
			<if test="identityNo != null">
				and identity_no = #{identityNo}
			</if>
			<if test="uniqueNumber != null">
				and unique_number = #{uniqueNumber}
			</if>
			<if test="deviceName != null">
				and device_name = #{deviceName}
			</if>
			<if test="orgName != null">
				and org_name = #{orgName}
			</if>
			<if test="recognizeTime != null">
				and recognize_time = #{recognizeTime}
			</if>
			<if test="subOrgId != null">
				and sub_org_id = #{subOrgId}
			</if>
			<if test="subOrgCode != null">
				and sub_org_code = #{subOrgCode}
			</if>
			<if test="subOrgRemark != null">
				and sub_org_remark = #{subOrgRemark}
			</if>
			<if test="relationSubOrgRemark != null">
				and relation_sub_org_remark = #{relationSubOrgRemark}
			</if>
			<if test="quality != null">
				and quality = #{quality}
			</if>
			<if test="confidence != null">
				and confidence = #{confidence}
			</if>
			<if test="recognizeType != null">
				and recognize_type = #{recognizeType}
			</if>
			<if test="realName != null and department!=null">
				AND (real_name LIKE concat('%', #{realName}, '%') OR department LIKE concat('%', #{department}, '%'))
			</if>
			<if test="recognizeUserType != null">
				and recognize_user_type = #{recognizeUserType}
			</if>
			<if test="status != null">
				and status = #{status}
			</if>
			<if test="searchBeginDate != null">
				<![CDATA[ and recognize_time >= #{searchBeginDate}]]>
			</if>
			<if test="searchEndDate != null">
				<![CDATA[ and recognize_time <= #{searchEndDate}]]>
			</if>
		</where>
	</sql>

	<sql id="sql_view_where">
	    from attence_recognize_record
	    <where>
    	<if test="recognizeRecordId != null">
		      recognize_record_id = #{recognizeRecordId}
		</if>
		<if test="personId != null">
		      and person_id = #{personId}
		</if>
		<if test="userId != null">
		      and user_id = #{userId}
		</if>
		<if test="facePicId != null">
		      and face_pic_id = #{facePicId}
		</if>
		<if test="orgId != null">
		      and org_id = #{orgId}
		</if>
		<if test="catchImageUrl != null">
		      and catch_image_url = #{catchImageUrl}
		</if>
		<if test="matchImageUrl != null">
		      and match_image_url = #{matchImageUrl}
		</if>
		<if test="mobile != null">
		      and mobile = #{mobile}
		</if>
		<if test="identityNo != null">
		      and identity_no = #{identityNo}
		</if>
		<if test="uniqueNumber != null">
		      and unique_number = #{uniqueNumber}
		</if>
		<if test="deviceName != null">
			and device_name = #{deviceName}
		</if>
		<if test="orgName != null">
		      and org_name = #{orgName}
		</if>
		<if test="recognizeTime != null">
		      and recognize_time = #{recognizeTime}
		</if>
		<if test="subOrgId != null">
		      and sub_org_id = #{subOrgId}
		</if>
		<if test="subOrgCode != null">
		      and sub_org_code = #{subOrgCode}
		</if>
		<if test="subOrgRemark != null">
		      and sub_org_remark = #{subOrgRemark}
		</if>
		<if test="relationSubOrgRemark != null">
		      and relation_sub_org_remark = #{relationSubOrgRemark}
		</if>
		<if test="department != null">
		      and department like "%"#{department}"%"
		</if>
		<if test="quality != null">
		      and quality = #{quality}
		</if>
		<if test="confidence != null">
		      and confidence = #{confidence}
		</if>
		<if test="recognizeType != null">
		      and recognize_type = #{recognizeType}
		</if>
		<if test="realName != null">
		      and real_name = #{realName}
		</if>
		<if test="recognizeUserType != null">
		      and recognize_user_type = #{recognizeUserType}
		</if>
		<if test="status != null">
		      and status = #{status}
		</if>
		<if test="searchBeginDate != null">
		<![CDATA[ and recognize_time >= #{searchBeginDate}]]>
		</if>
		<if test="searchEndDate != null">
		<![CDATA[ and recognize_time <= #{searchEndDate}]]>
		</if>
		</where>
	</sql>	
	
	<sql id="sql_select">
		select
			recognize_record_id,
			person_id,
			user_id,
			face_pic_id,
			org_id,
			catch_image_url,
			match_image_url,
			mobile,
			identity_no,
			unique_number,
			device_name,
			org_name,
			recognize_time,
			sub_org_id,
			sub_org_code,
			sub_org_remark,
			relation_sub_org_remark,
			department,
			department_id,
			quality,
			confidence,
			recognize_type,
			real_name,
			recognize_user_type,
			status,
			sync_status,
			retry_count,
			next_retry_time,
			gmt_create,
			gmt_modify	
	</sql>  
</mapper>